var e=require("eventemitter3").EventEmitter;function t(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var r=function(){function e(t){var n,r,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=0,(r="cachedCredentialsExpireAt")in(n=this)?Object.defineProperty(n,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[r]=i,this.signaling=t}var r,i,o,a,s;return r=e,(i=[{key:"fillCredentials",value:(a=regeneratorRuntime.mark((function e(t){var n,r,i,o,a=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=JSON.parse(JSON.stringify(t)),void 0===t.testproxyURL){e.next=3;break}return e.abrupt("return",i);case 3:if(null!==(n=null===(r=i.iceServers)||void 0===r?void 0:r.some((function(e){return"turn:turn.rtc.poki.com"===e.urls||e.urls.includes("turn:turn.rtc.poki.com")})))&&void 0!==n&&n&&void 0!==i.iceServers){e.next=6;break}return e.abrupt("return",i);case 6:return void 0===this.runningPromise&&(this.runningPromise=new Promise((function(e){null!=a.cachedCredentials&&a.cachedCredentialsExpireAt>performance.now()?e(a.cachedCredentials):(a.signaling.once("credentials",(function(t){var n;"credentials"===t.type&&(a.cachedCredentials=t,a.cachedCredentialsExpireAt=performance.now()+1e3*((null!==(n=t.lifetime)&&void 0!==n?n:0)-60),e(t))})),a.signaling.send({type:"credentials"}),setTimeout((function(){e({type:"credentials"})}),5e3))}))),e.next=9,this.runningPromise;case 9:if(o=e.sent,this.runningPromise=void 0,void 0!==o.url){e.next=13;break}return e.abrupt("return",i);case 13:return i.iceServers.forEach((function(e){var t;("turn:turn.rtc.poki.com"===e.urls||e.urls.includes("turn:turn.rtc.poki.com"))&&(e.urls=null!==(t=o.url)&&void 0!==t?t:"",e.username=o.username,e.credential=o.credential)})),e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this)})),s=function(){var e=this,n=arguments;return new Promise((function(r,i){var o=a.apply(e,n);function s(e){t(o,r,i,s,c,"next",e)}function c(e){t(o,r,i,s,c,"throw",e)}s(void 0)}))},function(e){return s.apply(this,arguments)})}])&&n(r.prototype,i),o&&n(r,o),e}();function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw o}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function s(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=h(e);if(t){var i=h(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(d,e);var n,r,i,a,f,h=l(d);function d(e,t,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),(r=h.call(this)).network=e,r.connections=t,r.replayQueue=new Map,r.ws=new WebSocket(n),r.ws.addEventListener("open",(function(){r.send({type:"hello",game:r.network.gameID}),r.network._prefetchTURNCredentials()})),r.ws.addEventListener("error",(function(e){r.network.emit("signalingerror",e),0===r.network.listenerCount("signalingerror")&&console.error("signallingerror not handled:",e)})),r.ws.addEventListener("close",(function(){r.network.close("signaling websocket closed")})),r.ws.addEventListener("message",(function(e){r.handleSignalingMessage(e.data).catch((function(e){}))})),r}return n=d,(r=[{key:"close",value:function(){this.ws.close()}},{key:"send",value:function(e){if(this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState===WebSocket.OPEN){this.network.log("sending signaling packet:",e.type);var t=JSON.stringify(e);this.ws.send(t)}}},{key:"handleSignalingMessage",value:(a=regeneratorRuntime.mark((function e(t){var n,r,i,a,s,c,u,l,f,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=JSON.parse(t),this.network.log("signaling packet received:",r.type),e.t0=r.type,e.next="welcome"===e.t0?6:"joined"===e.t0?11:"connect"===e.t0?15:"disconnect"===e.t0?38:"candidate"===e.t0||"description"===e.t0?40:"credentials"===e.t0?49:51;break;case 6:if(""!==r.id){e.next=8;break}throw new Error("missing id on received welcome packet");case 8:return this.receivedID=r.id,this.network.emit("ready"),e.abrupt("break",51);case 11:if(""!==r.lobby){e.next=13;break}throw new Error("missing lobby on received connect packet");case 13:return this.network.emit("lobby",r.lobby),e.abrupt("break",51);case 15:if(this.receivedID!==r.id){e.next=17;break}return e.abrupt("return");case 17:return e.next=19,this.network._addPeer(r.id,r.polite);case 19:i=o(null!==(n=this.replayQueue.get(r.id))&&void 0!==n?n:[]),e.prev=20,i.s();case 22:if((a=i.n()).done){e.next=28;break}return c=a.value,e.next=26,null===(s=this.connections.get(r.id))||void 0===s?void 0:s._onSignalingMessage(c);case 26:e.next=22;break;case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(20),i.e(e.t1);case 33:return e.prev=33,i.f(),e.finish(33);case 36:return this.replayQueue.delete(r.id),e.abrupt("break",51);case 38:return this.connections.has(r.id)&&(null===(u=this.connections.get(r.id))||void 0===u||u.close()),e.abrupt("break",51);case 40:if(!this.connections.has(r.source)){e.next=45;break}return e.next=43,null===(l=this.connections.get(r.source))||void 0===l?void 0:l._onSignalingMessage(r);case 43:e.next=48;break;case 45:(h=null!==(f=this.replayQueue.get(r.source))&&void 0!==f?f:[]).push(r),this.replayQueue.set(r.source,h);case 48:return e.abrupt("break",51);case 49:return this.emit("credentials",r),e.abrupt("break",51);case 51:e.next=56;break;case 53:e.prev=53,e.t2=e.catch(0),this.network.emit("signalingerror",e.t2);case 56:case"end":return e.stop()}}),e,this,[[0,53],[20,30,33,36]])})),f=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){s(i,n,r,o,c,"next",e)}function c(e){s(i,n,r,o,c,"throw",e)}o(void 0)}))},function(e){return f.apply(this,arguments)})}])&&c(n.prototype,r),i&&c(n,i),d}();function p(e){return function(e){if(Array.isArray(e))return v(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return v(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return v(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){function e(t,n){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),y(this,"window",[]),y(this,"lastPingSentAt",0),y(this,"last",0),y(this,"average",0),y(this,"jitter",0),y(this,"max",0),y(this,"min",0),this.peer=t,this.control=n,void 0!==n&&(this.ping(),n.addEventListener("message",(function(e){return r.onMessage(e.data)})))}var t,n,r;return t=e,(n=[{key:"ping",value:function(){var e,t;this.lastPingSentAt=performance.now(),"open"===(null===(e=this.control)||void 0===e?void 0:e.readyState)&&(null===(t=this.control)||void 0===t||t.send("ping"))}},{key:"onMessage",value:function(e){var t,n,r=this;if("ping"!==e){if("pong"===e){var i=performance.now()-this.lastPingSentAt;this.window.unshift(i),this.window.length>50&&this.window.pop(),this.last=i,this.max=Math.max.apply(Math,p(this.window)),this.min=Math.min.apply(Math,p(this.window)),this.average=this.window.reduce((function(e,t){return e+t}),0)/this.window.length,this.window.length>1&&(this.jitter=this.window.slice(1).map((function(e,t){return Math.abs(e-r.window[t])})).reduce((function(e,t){return e+t}),0)/(this.window.length-1)),setTimeout((function(){return r.ping()}),500-i)}}else"open"===(null===(t=this.control)||void 0===t?void 0:t.readyState)&&(null===(n=this.control)||void 0===n||n.send("pong"))}}])&&g(t.prototype,n),r&&g(t,r),e}();function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){O(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function k(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function S(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){k(o,r,i,a,s,"next",e)}function s(e){k(o,r,i,a,s,"throw",e)}a(void 0)}))}}function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P=function(){function e(t,n,r,i,o){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),O(this,"makingOffer",!1),O(this,"ignoreOffer",!1),O(this,"isSettingRemoteAnswerPending",!1),O(this,"opened",!1),O(this,"closing",!1),O(this,"reconnecting",!1),O(this,"allowNextManualRestartIceAt",0),O(this,"latency",new b(this)),O(this,"lastMessageReceivedAt",0),this.network=t,this.signaling=n,this.id=r,this.config=i,this.polite=o,this.channels={},this.network.log("creating peer"),this.testSessionWrapper=void 0,this.conn=new RTCPeerConnection(i),void 0===i.testproxyURL?this.conn.addEventListener("icecandidate",(function(e){var t=e.candidate;null!==t&&n.send({type:"candidate",source:a.network.id,recipient:a.id,candidate:t})})):this.testSessionWrapper=j,this.conn.addEventListener("negotiationneeded",(function(){a.politenessTimeout=setTimeout((function(){S(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!a.closing){e.next=3;break}return e.abrupt("return");case 3:a.makingOffer=!0,e.next=13;break;case 8:return e.t1=e.sent,e.next=11,e.t0.setLocalDescription.call(e.t0,e.t1);case 11:e.next=15;break;case 13:return e.next=15,a.conn.setLocalDescription();case 15:if(null==(t=a.conn.localDescription)){e.next=20;break}return e.next=19,null===(n=a.testSessionWrapper)||void 0===n?void 0:n.call(a,t,a.config,a.network.id,a.id);case 19:a.signaling.send({type:"description",source:a.network.id,recipient:a.id,description:t});case 20:e.next=26;break;case 22:e.prev=22,e.t2=e.catch(0),a.network.emit("signalingerror",e.t2),0===a.network.listenerCount("signalingerror")&&console.error("signallingerror not handled:",e.t2);case 26:return e.prev=26,a.makingOffer=!1,e.finish(26);case 29:case"end":return e.stop()}}),e,null,[[0,22,26,29]])})))().catch((function(e){}))}),a.polite?100:0)})),this.checkStateInterval=setInterval((function(){a.checkState()}),500),this.conn.addEventListener("signalingstatechange",(function(){return a.checkState()})),this.conn.addEventListener("connectionstatechange",(function(){return a.checkState()})),this.conn.addEventListener("iceconnectionstatechange",(function(){return a.checkState()})),this.network.emit("connecting",this);var s=0,c=function(e){var t=a.conn.createDataChannel(e,m(m({},a.network.dataChannels[e]),{},{id:s++,negotiated:!0}));t.binaryType="arraybuffer",t.addEventListener("error",(function(e){return a.onError(e)})),t.addEventListener("closing",(function(){return a.checkState()})),t.addEventListener("close",(function(){return a.checkState()})),t.addEventListener("open",(function(){a.opened||Object.values(a.channels).some((function(e){return"open"!==e.readyState}))||("control"in a.channels&&(a.latency=new b(a,a.channels.control)),void 0!==a.politenessTimeout&&clearTimeout(a.politenessTimeout),a.signaling.send({type:"connected",id:a.id}),a.opened=!0,a.network.emit("connected",a))})),t.addEventListener("message",(function(t){a.lastMessageReceivedAt=performance.now(),"control"!==e&&a.network.emit("message",a,e,t.data)})),a.channels[e]=t};for(var u in this.network.dataChannels)c(u)}var t,n,r,i;return t=e,(n=[{key:"close",value:function(e){this.closing||(this.closing=!0,this.signaling.send({type:"disconnected",id:this.id,reason:null!=e?e:"normal closure"}),Object.values(this.channels).forEach((function(e){return e.close()})),this.conn.close(),this.network._removePeer(this),null!=this.checkStateInterval&&clearInterval(this.checkStateInterval),this.opened&&this.network.emit("disconnected",this))}},{key:"checkState",value:function(){var e,t=null!==(e=this.conn.connectionState)&&void 0!==e?e:this.conn.iceConnectionState;if(!this.closing)if(this.opened){if(Object.values(this.channels).some((function(e){return"open"!==e.readyState}))&&this.close("data channel closed"),this.reconnecting||"disconnected"!==t&&"failed"!==t?this.reconnecting&&"connected"===t&&(this.reconnecting=!1,this.network.emit("reconnected",this)):(this.reconnecting=!0,this.conn.restartIce(),this.network.emit("reconnecting",this)),!this.reconnecting&&"control"in this.channels){var n=this.lastMessageReceivedAt;if(0!==n){var r=performance.now();r-n>1e3&&r>this.allowNextManualRestartIceAt&&(this.allowNextManualRestartIceAt=r+1e4,this.conn.restartIce())}}}else"failed"===t&&this.close("connecting failed")}},{key:"onError",value:function(e){this.network.emit("rtcerror",e),0===this.network.listenerCount("rtcerror")&&console.error("rtcerror not handled:",e),this.checkState()}},{key:"_onSignalingMessage",value:(i=S(regeneratorRuntime.mark((function e(t){var n,r,i,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.type,e.next="candidate"===e.t0?3:"description"===e.t0?14:42;break;case 3:if(null==t.candidate){e.next=13;break}return e.prev=4,e.next=7,this.conn.addIceCandidate(t.candidate);case 7:e.next=13;break;case 9:if(e.prev=9,e.t1=e.catch(4),this.ignoreOffer){e.next=13;break}throw e.t1;case 13:return e.abrupt("break",42);case 14:if(n=t.description,r=!this.makingOffer&&("stable"===this.conn.signalingState||this.isSettingRemoteAnswerPending),i="offer"===n.type&&!r,this.ignoreOffer=!this.polite&&i,!this.ignoreOffer){e.next=20;break}return e.abrupt("return");case 20:return this.isSettingRemoteAnswerPending="answer"===n.type,e.next=23,this.conn.setRemoteDescription(n);case 23:if(this.isSettingRemoteAnswerPending=!1,"offer"!==n.type){e.next=41;break}e.next=34;break;case 29:return e.t3=e.sent,e.next=32,e.t2.setLocalDescription.call(e.t2,e.t3);case 32:e.next=36;break;case 34:return e.next=36,this.conn.setLocalDescription();case 36:if(null==(o=this.conn.localDescription)){e.next=41;break}return e.next=40,null===(a=this.testSessionWrapper)||void 0===a?void 0:a.call(this,o,this.config,this.network.id,this.id);case 40:this.signaling.send({type:"description",source:this.network.id,recipient:this.id,description:o});case 41:return e.abrupt("break",42);case 42:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(e){return i.apply(this,arguments)})},{key:"send",value:function(e,t){if(!(e in this.channels))throw new Error("unknown channel "+e);var n=this.channels[e];"open"===n.readyState&&n.send(t)}},{key:"toString",value:function(){return"[Peer: ".concat(this.id,"]")}}])&&x(t.prototype,n),r&&x(t,r),e}();function j(e,t,n,r){return E.apply(this,arguments)}function E(){return(E=S(regeneratorRuntime.mark((function e(t,n,r,i){var o,a,s,c,u,l,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==n.testproxyURL){e.next=2;break}return e.abrupt("return");case 2:o=(o=t.sdp.split("\r\n")).filter((function(e){return!e.startsWith("a=candidate")||e.includes("127.0.0.1")&&e.includes("udp")})),a=0;case 5:if(!(a<o.length)){e.next=20;break}if(!(s=o[a]).startsWith("a=candidate")||!s.includes("127.0.0.1")){e.next=17;break}if(null==(u=null===(c=s.split("127.0.0.1 ").pop())||void 0===c?void 0:c.split(" ")[0])){e.next=17;break}return e.next=12,fetch("".concat(n.testproxyURL,"/create?id=").concat(r+i,"&port=").concat(u));case 12:return l=e.sent,e.next=15,l.text();case 15:f=e.sent,o[a]=s.replaceAll(" ".concat(u," ")," ".concat(f," "));case 17:a++,e.next=5;break;case 20:t.sdp=o.join("\r\n");case 22:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function C(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function A(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return L(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return L(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){throw e})),f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){s=!0,o=e})),f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function L(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function I(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function M(e,t){return(M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=U(e);if(t){var i=U(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return D(this,n)}}function D(e,t){return!t||"object"!==R(t)&&"function"!=typeof t?N(e):t}function N(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function U(e){return(U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Q=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&M(e,t)}(u,e);var n,i,o,a,s,c=T(u);function u(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:B;return _(this,u),W(N(t=c.call(this)),"_closing",!1),W(N(t),"dataChannels",$),W(N(t),"log",(function(){})),t.gameID=e,t.rtcConfig=n,t.peers=new Map,t.signaling=new d(N(t),t.peers,i),t.credentials=new r(t.signaling),t.unloadListener=function(){return t.close()},window.addEventListener("unload",t.unloadListener),t}return n=u,(i=[{key:"create",value:function(){this.signaling.send({type:"create"})}},{key:"join",value:function(e){this.signaling.send({type:"join",lobby:e})}},{key:"close",value:function(e){if(!this._closing){this._closing=!0,this.emit("close",e),""!==this.id&&this.signaling.send({type:"leave",id:this.id,reason:null!=e?e:"normal closure"});var t,n=A(this.peers.values());try{for(n.s();!(t=n.n()).done;)t.value.close(e)}catch(e){n.e(e)}finally{n.f()}this.signaling.close(),window.removeEventListener("unload",this.unloadListener)}}},{key:"send",value:function(e,t,n){if(!(e in this.dataChannels))throw new Error("unknown channel "+e);var r;this.peers.has(t)&&(null===(r=this.peers.get(t))||void 0===r||r.send(e,n))}},{key:"broadcast",value:function(e,t){if(!(e in this.dataChannels))throw new Error("unknown channel "+e);var n,r=A(this.peers.values());try{for(r.s();!(n=r.n()).done;)n.value.send(e,t)}catch(e){r.e(e)}finally{r.f()}}},{key:"_addPeer",value:(a=regeneratorRuntime.mark((function e(t,n){var r,i,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.credentials.fillCredentials(this.rtcConfig);case 2:(i=e.sent).iceServers=null===(r=i.iceServers)||void 0===r?void 0:r.filter((function(e){return!(e.urls.includes("turn:")&&void 0===e.username)})),o=new P(this,this.signaling,t,i,n),this.peers.set(t,o);case 6:case"end":return e.stop()}}),e,this)})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){C(i,n,r,o,s,"next",e)}function s(e){C(i,n,r,o,s,"throw",e)}o(void 0)}))},function(e,t){return s.apply(this,arguments)})},{key:"_removePeer",value:function(e){return this.peers.delete(e.id)}},{key:"_prefetchTURNCredentials",value:function(){this.credentials.fillCredentials(this.rtcConfig).catch((function(){}))}},{key:"id",get:function(){var e;return null!==(e=this.signaling.receivedID)&&void 0!==e?e:""}},{key:"closing",get:function(){return this._closing}},{key:"size",get:function(){return this.peers.size}}])&&I(n.prototype,i),o&&I(n,o),u}();exports.Network=Q;var B="wss://netlib.poki.io/v0/signaling";exports.DefaultSignalingURL=B;var J={iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:"turn:turn.rtc.poki.com"}]};exports.DefaultRTCConfiguration=J;var $={reliable:{ordered:!0},unreliable:{ordered:!0,maxRetransmits:0},control:{ordered:!1}};exports.DefaultDataChannels=$;
//# sourceMappingURL=netlib.js.map
