var e=require("eventemitter3").EventEmitter;function n(e,n,t,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,i)}function t(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var r=function(){function e(n,t,r){var i=this;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.network=n,this.connections=t,this.ws=new WebSocket(r),this.ws.addEventListener("open",(function(){i.network.emit("ready")})),this.ws.addEventListener("error",(function(e){i.network.emit("signalingerror",e)})),this.ws.addEventListener("close",(function(){i.network.close("signaling websocket closed")})),this.ws.addEventListener("message",(function(e){i.handleSignalingMessage(e.data).catch((function(e){}))}))}var r,i,o,a,c;return r=e,(i=[{key:"close",value:function(e){null!=this.receivedID&&this.send({type:"leave",id:this.receivedID,reason:null!=e?e:"normal closure"}),this.ws.close()}},{key:"send",value:function(e){if(this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState===WebSocket.OPEN){this.network.log("sending signaling packet:",e.type);var n=JSON.stringify(e);this.ws.send(n)}}},{key:"handleSignalingMessage",value:(a=regeneratorRuntime.mark((function e(n){var t,r,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=JSON.parse(n),this.network.log("signaling packet received:",t.type),e.t0=t.type,e.next="joined"===e.t0?6:"connect"===e.t0?13:"disconnected"===e.t0?17:"candidate"===e.t0||"description"===e.t0?19:26;break;case 6:if(""!==t.id){e.next=8;break}throw new Error("missing id on received connect packet");case 8:if(""!==t.lobby){e.next=10;break}throw new Error("missing lobby on received connect packet");case 10:return this.receivedID=t.id,this.network.emit("lobby",t.lobby),e.abrupt("break",26);case 13:if(this.receivedID!==t.id){e.next=15;break}return e.abrupt("return");case 15:return this.network._addPeer(t.id,t.polite),e.abrupt("break",26);case 17:return this.connections.has(t.id)&&(null===(r=this.connections.get(t.id))||void 0===r||r.close()),e.abrupt("break",26);case 19:if(!this.connections.has(t.source)){e.next=24;break}return e.next=22,null===(i=this.connections.get(t.source))||void 0===i?void 0:i._onSignalingMessage(t);case 22:e.next=25;break;case 24:console.error("recieved packet for unknown connection (id):",t.source);case 25:return e.abrupt("break",26);case 26:e.next=31;break;case 28:e.prev=28,e.t1=e.catch(0),this.network.emit("signalingerror",e.t1);case 31:case"end":return e.stop()}}),e,this,[[0,28]])})),c=function(){var e=this,t=arguments;return new Promise((function(r,i){var o=a.apply(e,t);function c(e){n(o,r,i,c,s,"next",e)}function s(e){n(o,r,i,c,s,"throw",e)}c(void 0)}))},function(e){return c.apply(this,arguments)})}])&&t(r.prototype,i),o&&t(r,o),e}();function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){u(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n,t,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,i)}function c(e){return function(){var n=this,t=arguments;return new Promise((function(r,i){var o=e.apply(n,t);function c(e){a(o,r,i,c,s,"next",e)}function s(e){a(o,r,i,c,s,"throw",e)}c(void 0)}))}}function s(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var l=function(){function e(n,t,r,i,a){var s=this;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"makingOffer",!1),u(this,"ignoreOffer",!1),u(this,"isSettingRemoteAnswerPending",!1),u(this,"opened",!1),u(this,"closing",!1),u(this,"latency",0),this.network=n,this.signaling=t,this.id=r,this.polite=i,this.channels={},this.network.log("creating peer"),this.conn=new RTCPeerConnection(a),this.conn.addEventListener("icecandidate",(function(e){var n=e.candidate;null!==n&&t.send({type:"candidate",source:s.network.id,recipient:s.id,candidate:n})})),this.conn.addEventListener("negotiationneeded",(function(){setTimeout((function(){c(regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!s.closing){e.next=3;break}return e.abrupt("return");case 3:s.makingOffer=!0,e.next=13;break;case 8:return e.t1=e.sent,e.next=11,e.t0.setLocalDescription.call(e.t0,e.t1);case 11:e.next=15;break;case 13:return e.next=15,s.conn.setLocalDescription();case 15:null!=(n=s.conn.localDescription)&&s.signaling.send({type:"description",source:s.network.id,recipient:s.id,description:n}),e.next=22;break;case 19:e.prev=19,e.t2=e.catch(0),s.network.emit("signalingerror",e.t2);case 22:return e.prev=22,s.makingOffer=!1,e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[0,19,22,25]])})))().catch((function(e){}))}),s.polite?100:0)})),this.checkStateInterval=setInterval((function(){s.checkState()}),500),this.conn.addEventListener("signalingstatechange",(function(){return s.checkState()})),this.conn.addEventListener("connectionstatechange",(function(){return s.checkState()})),this.conn.addEventListener("iceconnectionstatechange",(function(){"failed"===s.conn.iceConnectionState&&s.conn.restartIce()})),this.network.emit("peerconnecting",this);var l=0,f=function(e){var n=s.conn.createDataChannel(e,o(o({},s.network.dataChannels[e]),{},{id:l++,negotiated:!0}));n.addEventListener("error",(function(e){return s.onError(e)})),n.addEventListener("close",(function(){return s.checkState()})),n.addEventListener("open",(function(){s.opened||Object.values(s.channels).some((function(e){return"open"!==e.readyState}))||(s.signaling.send({type:"connected",id:s.id}),s.opened=!0,s.network.emit("peerconnected",s))})),n.addEventListener("message",(function(n){s.network.emit("message",s,e,n.data)})),s.channels[e]=n};for(var h in this.network.dataChannels)f(h)}var n,t,r,i;return n=e,(t=[{key:"close",value:function(e){this.closing||(this.closing=!0,this.signaling.send({type:"disconnected",id:this.id,reason:null!=e?e:"normal closure"}),Object.values(this.channels).forEach((function(e){return e.close()})),this.conn.close(),this.network._removePeer(this),null!=this.checkStateInterval&&clearInterval(this.checkStateInterval),this.opened&&this.network.emit("peerdisconnected",this))}},{key:"checkState",value:function(){var e=this;this.closing||(this.opened?(Object.values(this.channels).some((function(e){return"open"!==e.readyState}))&&this.close("data channel closed"),"connected"!==this.conn.connectionState&&this.close("invalid connection state ".concat(this.conn.connectionState,"/").concat(this.conn.signalingState)),this.conn.getStats().then((function(n){n.forEach((function(n){var t;"transport"===n.type&&(e.latency=null!==(t=n.currentRoundTripTime)&&void 0!==t?t:0)}))})).catch((function(e){}))):"failed"===this.conn.connectionState&&this.close("connecting failed"))}},{key:"onError",value:function(e){this.network.emit("rtcerror",e),this.checkState()}},{key:"_onSignalingMessage",value:(i=c(regeneratorRuntime.mark((function e(n){var t,r,i,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=n.type,e.next="candidate"===e.t0?3:"description"===e.t0?14:39;break;case 3:if(null==n.candidate){e.next=13;break}return e.prev=4,e.next=7,this.conn.addIceCandidate(n.candidate);case 7:e.next=13;break;case 9:if(e.prev=9,e.t1=e.catch(4),this.ignoreOffer){e.next=13;break}throw e.t1;case 13:return e.abrupt("break",39);case 14:if(t=n.description,r=!this.makingOffer&&("stable"===this.conn.signalingState||this.isSettingRemoteAnswerPending),i="offer"===t.type&&!r,this.ignoreOffer=!this.polite&&i,!this.ignoreOffer){e.next=20;break}return e.abrupt("return");case 20:return this.isSettingRemoteAnswerPending="answer"===t.type,e.next=23,this.conn.setRemoteDescription(t);case 23:if(this.isSettingRemoteAnswerPending=!1,"offer"!==t.type){e.next=38;break}e.next=34;break;case 29:return e.t3=e.sent,e.next=32,e.t2.setLocalDescription.call(e.t2,e.t3);case 32:e.next=36;break;case 34:return e.next=36,this.conn.setLocalDescription();case 36:null!=(o=this.conn.localDescription)&&this.signaling.send({type:"description",source:this.network.id,recipient:this.id,description:o});case 38:return e.abrupt("break",39);case 39:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(e){return i.apply(this,arguments)})},{key:"send",value:function(e,n){if(!(e in this.channels))throw new Error("unknown channel "+e);var t=this.channels[e];"open"===t.readyState&&t.send(n)}},{key:"toString",value:function(){return"[Peer: ".concat(this.id,"]")}}])&&s(n.prototype,t),r&&s(n,r),e}();function f(e){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(!e)return;if("string"==typeof e)return d(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return d(e,n)}(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){function n(n){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(e){throw e})),f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){function n(n){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(e){c=!0,o=e})),f:function(){try{a||null==t.return||t.return()}finally{if(c)throw o}}}}function d(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function p(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function g(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,n){return(v=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function y(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=w(e);if(n){var i=w(this).constructor;t=Reflect.construct(r,arguments,i)}else t=r.apply(this,arguments);return b(this,t)}}function b(e,n){return!n||"object"!==f(n)&&"function"!=typeof n?k(e):n}function k(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(e){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var S=function(n){!function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&v(e,n)}(c,e);var t,i,o,a=y(c);function c(e){var n,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O;return p(this,c),m(k(n=a.call(this)),"closing",!1),m(k(n),"dataChannels",E),m(k(n),"log",(function(){})),n.gameID=e,n.signalingURL=t,n.peers=new Map,n.signaling=new r(k(n),n.peers,t),n}return t=c,(i=[{key:"create",value:function(){this.signaling.send({type:"create",game:this.gameID})}},{key:"join",value:function(e){this.signaling.send({type:"join",game:this.gameID,lobby:e})}},{key:"close",value:function(e){if(!this.closing){this.closing=!0,this.emit("close",e);var n,t=h(this.peers.values());try{for(t.s();!(n=t.n()).done;)n.value.close(e)}catch(e){t.e(e)}finally{t.f()}this.signaling.close(e)}}},{key:"send",value:function(e,n,t){if(!(e in this.dataChannels))throw new Error("unknown channel "+e);var r;this.peers.has(n)&&(null===(r=this.peers.get(n))||void 0===r||r.send(e,t))}},{key:"broadcast",value:function(e,n){if(!(e in this.dataChannels))throw new Error("unknown channel "+e);var t,r=h(this.peers.values());try{for(r.s();!(t=r.n()).done;)t.value.send(e,n)}catch(e){r.e(e)}finally{r.f()}}},{key:"_addPeer",value:function(e,n){var t=new l(this,this.signaling,e,n,x);return this.peers.set(e,t),t}},{key:"_removePeer",value:function(e){return this.peers.delete(e.id)}},{key:"id",get:function(){var e;return null!==(e=this.signaling.receivedID)&&void 0!==e?e:""}},{key:"size",get:function(){return this.peers.size}}])&&g(t.prototype,i),o&&g(t,o),c}();exports.Network=S;var O="ws://localhost:8080/v0/signaling";exports.DefaultSignalingURL=O;var x={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun3.l.google.com:19302"]},{urls:["turn:localhost:8080"],username:"optional-username",credential:"secret",credentialType:"password"}]};exports.DefaultRTCConfiguration=x;var E={reliable:{ordered:!0},unreliable:{ordered:!1,maxRetransmits:0}};exports.DefaultDataChannels=E;
//# sourceMappingURL=netlib.js.map
